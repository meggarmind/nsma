/**
 * Template Generator for Project Wizard
 * Generates nsma-config.md and session-start.sh hook files
 */

/**
 * Generate .nsma-config.md content
 * @param {string} projectName - Name of the project
 * @param {string} style - 'full' for complete template, 'minimal' for basic
 * @returns {string} Markdown content
 */
export function generateNsmaConfig(projectName, style = 'full') {
  const date = new Date().toISOString().slice(0, 10);

  if (style === 'minimal') {
    return `---
version: "1.0"
auto_import: true
created: "${date}"
---

# ${projectName} - NSMA Configuration

## Development Phases

### Backlog
- **ID**: \`backlog\`
- **Description**: Default phase for unassigned tasks
- **Keywords**: todo, backlog, later
- **Priority**: 99

## Modules

<!-- Add modules as your project grows -->
<!-- Example:
### Core
- **ID**: \`core\`
- **Phase**: \`backlog\`
- **Paths**:
  - \`src/\`
-->
`;
  }

  // Full template
  return `---
version: "1.0"
auto_import: true
created: "${date}"
---

# ${projectName} - NSMA Configuration

This file defines the project structure for the Notion Sync Manager.
NSMA uses this to route tasks to the appropriate development phase.

## Development Phases

### Phase 1: Foundation
- **ID**: \`foundation\`
- **Description**: Core infrastructure, database schemas, authentication
- **Keywords**: database, schema, auth, setup, config, infrastructure
- **Priority**: 1

### Phase 2: Core Features
- **ID**: \`core-features\`
- **Description**: Primary application functionality
- **Keywords**: feature, api, endpoint, service, controller
- **Priority**: 2

### Phase 3: UI/UX
- **ID**: \`ui-ux\`
- **Description**: User interface and experience
- **Keywords**: ui, component, page, layout, style, css, design
- **Priority**: 3

### Phase 4: Polish & Optimization
- **ID**: \`polish\`
- **Description**: Performance, testing, documentation
- **Keywords**: test, optimize, performance, docs, documentation, refactor
- **Priority**: 4

### Backlog
- **ID**: \`backlog\`
- **Description**: Future enhancements and ideas
- **Keywords**: idea, future, enhancement, later
- **Priority**: 99

## Modules

### Core
- **ID**: \`core\`
- **Phase**: \`foundation\`
- **Paths**:
  - \`src/lib/\`
  - \`src/core/\`
  - \`lib/\`

### API
- **ID**: \`api\`
- **Phase**: \`core-features\`
- **Paths**:
  - \`src/api/\`
  - \`app/api/\`
  - \`routes/\`

### Components
- **ID**: \`components\`
- **Phase**: \`ui-ux\`
- **Paths**:
  - \`src/components/\`
  - \`components/\`

### Pages
- **ID**: \`pages\`
- **Phase**: \`ui-ux\`
- **Paths**:
  - \`src/pages/\`
  - \`app/\`
  - \`pages/\`

### Tests
- **ID**: \`tests\`
- **Phase**: \`polish\`
- **Paths**:
  - \`tests/\`
  - \`__tests__/\`
  - \`*.test.ts\`
  - \`*.spec.ts\`

## Module-Phase Mapping

The mapping above is automatically generated from module definitions.
You can also define explicit mappings here if needed.

---

## Notes

- Edit this file to match your project structure
- NSMA will re-import on project sync or when you trigger "Check for Config Files"
- Keywords are used to auto-assign tasks that don't have a module specified
- Priority determines the order phases appear in reports
`;
}

/**
 * Generate session-start.sh hook content
 * @param {string} projectRoot - Project root directory path
 * @param {string} projectName - Name of the project
 * @param {string} promptsPath - Path to prompts directory
 * @param {string} style - 'full' for complete template, 'minimal' for basic
 * @returns {string} Bash script content
 */
export function generateSessionStartHook(projectRoot, projectName, promptsPath, style = 'full') {
  // Escape any special characters in paths for shell
  const escapedRoot = projectRoot.replace(/'/g, "'\\''");
  const escapedName = projectName.replace(/'/g, "'\\''");
  const escapedPrompts = promptsPath.replace(/'/g, "'\\''");

  if (style === 'minimal') {
    return `#!/bin/bash
# ============================================================================
# ${projectName} - Session Start Hook (Minimal)
# ============================================================================
# Auto-generated by NSMA Project Wizard
# ============================================================================

PROJECT_ROOT='${escapedRoot}'
PROJECT_NAME='${escapedName}'
PROMPTS_DIR='${escapedPrompts}'
NSMA_CLI="\${HOME}/projects/Nsma/cli/index.js"

# Create subfolders if missing
mkdir -p "\$PROMPTS_DIR/pending" "\$PROMPTS_DIR/processed" "\$PROMPTS_DIR/archived" "\$PROMPTS_DIR/deferred" 2>/dev/null

echo "Project: \$PROJECT_NAME"
echo ""

# Run sync for this project if CLI exists
if [ -f "\$NSMA_CLI" ]; then
    echo "Running Notion sync..."
    node "\$NSMA_CLI" --project "\$PROJECT_NAME" 2>&1
    echo ""
else
    echo "NSMA CLI not found. Run sync from dashboard: http://localhost:3100"
fi

# Count pending prompts
PENDING_COUNT=\$(ls -1 "\$PROMPTS_DIR/pending"/*.md 2>/dev/null | wc -l)
echo "Pending prompts: \$PENDING_COUNT"
echo "Prompts location: \$PROMPTS_DIR/pending/"
echo ""
`;
  }

  // Full template with analysis features
  return `#!/bin/bash
# ============================================================================
# ${projectName} - Session Start Hook
# ============================================================================
# Auto-generated by NSMA Project Wizard
# Full-featured hook with pending prompt analysis
# ============================================================================

PROJECT_ROOT='${escapedRoot}'
PROJECT_NAME='${escapedName}'
PROMPTS_DIR='${escapedPrompts}'
NSMA_CLI="\${HOME}/projects/Nsma/cli/index.js"

# Check if prompts directory exists
if [ ! -d "\$PROMPTS_DIR" ]; then
    echo "No prompts directory found. Creating structure..."
fi

# Create subfolders if missing
mkdir -p "\$PROMPTS_DIR/pending" "\$PROMPTS_DIR/processed" "\$PROMPTS_DIR/archived" "\$PROMPTS_DIR/deferred" 2>/dev/null

# Try to extract current phase from TODO.md or .nsma-config.md
CURRENT_PHASE="Unknown"
if [ -f "\$PROJECT_ROOT/TODO.md" ]; then
    CURRENT_PHASE=\$(grep -m1 "^## Current Phase:" "\$PROJECT_ROOT/TODO.md" 2>/dev/null | sed 's/## Current Phase: //' | sed 's/ -.*//' | xargs)
    [ -z "\$CURRENT_PHASE" ] && CURRENT_PHASE="Unknown"
fi

echo "=================================================================="
echo "          NOTION SYNC MANAGER - Session Start"
echo "=================================================================="
echo ""
echo "Project: \$PROJECT_NAME"
echo "Current Phase: \$CURRENT_PHASE"
echo ""

# Run sync for this project if CLI exists
if [ -f "\$NSMA_CLI" ]; then
    echo "Running Notion sync..."
    node "\$NSMA_CLI" --project "\$PROJECT_NAME" 2>&1
    echo ""
else
    echo "NSMA CLI not found at \$NSMA_CLI"
    echo "Run sync manually from http://localhost:3100"
    echo ""
fi

# ============================================================================
# PENDING PROMPTS ANALYSIS
# ============================================================================
echo "=================================================================="
echo "PENDING PROMPTS"
echo "=================================================================="

PENDING_DIR="\$PROMPTS_DIR/pending"

if [ ! -d "\$PENDING_DIR" ] || [ -z "\$(ls -A "\$PENDING_DIR"/*.md 2>/dev/null)" ]; then
    echo "No pending prompts."
else
    aligned_count=0
    decision_count=0

    for f in "\$PENDING_DIR"/*.md; do
        [ -e "\$f" ] || continue

        filename=\$(basename "\$f")
        # Read from YAML frontmatter
        phase=\$(grep -m1 "^phase:" "\$f" 2>/dev/null | sed 's/phase: //')
        type=\$(grep -m1 "^type:" "\$f" 2>/dev/null | sed 's/type: //')
        priority=\$(grep -m1 "^priority:" "\$f" 2>/dev/null | sed 's/priority: //')
        title=\$(grep -m1 "^# Development Task:" "\$f" 2>/dev/null | sed 's/# Development Task: //')
        [ -z "\$title" ] && title="\$filename"

        # Types that always execute
        if [[ "\$type" =~ ^(Bug\\ Fix|Documentation|Security\\ Fix|Technical\\ Debt)\$ ]]; then
            echo "[EXECUTE] \$title"
            echo "   Type: \$type (always execute) | Priority: \$priority"
            ((aligned_count++))
        elif [[ "\$phase" == "\$CURRENT_PHASE" ]] || [[ "\$phase" == "Backlog" ]]; then
            echo "[EXECUTE] \$title"
            echo "   Phase: \$phase (aligned) | Priority: \$priority"
            ((aligned_count++))
        else
            echo "[DECISION] \$title"
            echo "   Phase: \$phase != \$CURRENT_PHASE | Priority: \$priority"
            ((decision_count++))
        fi
        echo ""
    done

    echo "=================================================================="
    echo "Summary: \$aligned_count ready, \$decision_count need decision"
fi

# ============================================================================
# DEFERRED PROMPTS CHECK
# ============================================================================
DEFERRED_DIR="\$PROMPTS_DIR/deferred"

if [ -d "\$DEFERRED_DIR" ] && [ -n "\$(ls -A "\$DEFERRED_DIR"/*.md 2>/dev/null)" ]; then
    echo ""
    echo "=================================================================="
    echo "DEFERRED PROMPTS (check for phase alignment)"
    echo "=================================================================="

    now_aligned=0

    for f in "\$DEFERRED_DIR"/*.md; do
        [ -e "\$f" ] || continue

        filename=\$(basename "\$f")
        phase=\$(grep -m1 "^phase:" "\$f" 2>/dev/null | sed 's/phase: //')
        title=\$(grep -m1 "^# Development Task:" "\$f" 2>/dev/null | sed 's/# Development Task: //')
        [ -z "\$title" ] && title="\$filename"

        if [[ "\$phase" == "\$CURRENT_PHASE" ]] || [[ "\$phase" == "Backlog" ]]; then
            echo "[NOW ALIGNED] \$title"
            echo "   Phase: \$phase -> mv deferred/\$filename pending/"
            ((now_aligned++))
        fi
    done

    if [ \$now_aligned -eq 0 ]; then
        echo "No deferred prompts aligned with current phase."
    else
        echo ""
        echo "Run: mv prompts/deferred/<file>.md prompts/pending/"
    fi
    echo "=================================================================="
fi

echo ""
echo "Prompts location: \$PROMPTS_DIR/pending/"
echo "Dashboard: http://localhost:3100"
echo ""
`;
}
